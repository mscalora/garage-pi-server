{% extends "layout.html" %}
{% block head %}

    <link rel="stylesheet" href="{{ url_for('static', filename='home.css') }}">

{% endblock %}

{% block body %}

    <div class="webcam-row row">
        <div class="col-sm-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <div class="dropdown camera-menu">
                        <button class="btn btn-xs btn-default dropdown-toggle" type="button" id="camera-menu-btn" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                            Select
                            <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="camera-menu-btn">
                            {% for camera in cameras.keys() %}
                            <li><a class="camera-item-link" href="#" data-camera="{{ camera }}">{{ cameras[camera]['name'] if 'name' in cameras[camera] else camera }}</a></li>
                            {% endfor %}
                        </ul>
                    </div>
                    <h3 class="panel-title">Camera</h3>
                </div>
                <div class="panel-body">
                    <div class="webcam-container">
                        <img class='placeholder' src="{{ url_for('static', filename='gdoor.jpg') }}">
                        <div class="img-area">
                            <img src="">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="controls-row row">
        <div class="col-sm-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Controls</h3>
                </div>
                <div class="panel-body">
                    <button class="btn-gdoor btn btn-default">Garage<br>Door</button>
                    <button class="btn-light btn btn-default"><i class="fa fa-lightbulb-o fa-4x"></i></button>
                    <button class="btn-buzzer btn btn-default"><i class="fa fa-bullhorn fa-4x"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div class="code-row row">
        <div class="col-sm-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <div class="code-closer">
                        <div class="code-closer-box">
                            <i class="fa fa-times"></i>
                        </div>
                    </div>
                    <h3 class="panel-title">Enter Code</h3>
                </div>
                <div class="panel-body">
                    <div class="keep-together">
                        <button class="btn btn-default">0</button>
                        <button class="btn btn-default">1</button>
                        <button class="btn btn-default">2</button>
                        <button class="btn btn-default">3</button>
                        <button class="btn btn-default">4</button>
                    </div>
                    <div class="keep-together">
                        <button class="btn btn-default">5</button>
                        <button class="btn btn-default">6</button>
                        <button class="btn btn-default">7</button>
                        <button class="btn btn-default">8</button>
                        <button class="btn btn-default">9</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block bottom %}
    <script>
        var camera;
        $('.camera-item-link').on('click', function(){
            var it = $(this);
            camera = it.data('camera');
            localStorage.camera = camera;
            $('.panel-title').text(it.text());
            it.closest('.open').find('button[data-toggle=dropdown]').dropdown('toggle');
            return false;
        });
        var camera_inited = false;
        if (localStorage && localStorage.camera) {
            $('.camera-item-link[data-camera]').each(function(){
                if ($(this).data('camera')===localStorage.camera) {
                    $(this).trigger('click');
                    camera_inited = true;
                }
            });
        }
        if (!camera_inited) {
            $('.camera-item-link:first').trigger('click');
        }

        function refresh_image(sel){
            var img = $(sel || this);
            var url = img.prop('src');
            var anchor = document.createElement('a');
            anchor.href = url;
            var params = parseUrlParams(anchor);
            params['ts'] = $.now();
            if (camera) {
                params['cam'] = camera;
            }
            anchor.search = formatUrlParams(params);
            console.log('Refresh: '+anchor.href);
            img.prop('src', anchor.href);
        }
        var recovery_timer
        $('.img-area img').on('load', function(){
            $('.placeholder').prop('src', $('.img-area img').prop('src'));
            setTimeout(refresh_image.bind($('.img-area img')), 1000);
            clearInterval(recovery_timer);
            recovery_timer = setInterval(function(){
                $('.img-area img').prop('src','/camera?ts='+ $.now());
            }, 5000);
        }).prop('src','/camera');
        var buttons = $('.controls-row .panel-body button');
        var h = 0, w = 0;
        buttons.each(function(){
            h = Math.max(h, $(this).outerHeight());
            w = Math.max(w, $(this).outerWidth());
        }).each(function(){
            $(this).height(h).width(w);
        });
    $('.code-row').hide();
    var code = '';
    var confirm = '{{ confirm_code }}';
    $('.btn-gdoor').on('click', function(){
        var h = $('.controls-row .panel-body').height();
        $('.controls-row').hide();
        $('.code-row').show().find('.panel-body').css('min-height', h);

    });
    $('.code-row .panel-heading .code-closer').on('click', reset_code);
    function reset_code(){
        $('.code-row').hide().find('.panel-body').css('min-height', '');
        $('.controls-row').show();
    }
    $('.code-row .panel-title').data('title', $('.code-row .panel-title').text());
    $('.code-row .panel-body button').on('click', function(){
        var char = $(this).text();
        code += char;
        $('.code-row .panel-title').text(code);
        if (code.length>=confirm.length) {
            if (code==confirm) {
                $.getJSON("/action/gdoor", reset_code);
            } else {
                reset_code();
            }
            $('.code-row .panel-title').text($('.code-row .panel-title').data('title'));
            code ='';
        }
    });
    $('.btn-light').on('click', function(){
        $.getJSON("/action/light");
    });
    $('.btn-buzzer').on('click', function(){
        $.getJSON("/action/buzzer");
    });
    </script>
{% endblock %}
